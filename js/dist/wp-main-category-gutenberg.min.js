"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _possibleConstructorReturn(t,e){return!e||"object"!==_typeof(e)&&"function"!=typeof e?_assertThisInitialized(t):e}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),t}var WPMainCategoryGutenberg=function(){var t=wp.hooks.addFilter,e=wp.element,n=e.createElement,r=e.Fragment,o=wp.components.SelectControl,i=wp.url.addQueryArgs,a=wp.apiFetch,s=lodash,u=s.sortBy,c=s.invoke,l=wp.data.select,f=wp.i18n.__,p={per_page:-1,orderby:"id",order:"asc",_fields:"id,name"};return function(){var e=function(){return document.getElementById("wpmc[_primary_category]")},s=function(){return e().value},h=function(t){return e().value=t},d={},y=function(){function t(e){_classCallCheck(this,t),this.slug=e,this.reset()}return _createClass(t,[{key:"registeredData",value:function(){return!!Object.keys(this.data).length}},{key:"reset",value:function(){this.data={}}},{key:"read",value:function(){return this.data}},{key:"get",value:function(t){return t in this.data&&this.data[t]||null}},{key:"set",value:function(t,e){return this.data[t]=e}}]),t}(),g=function(){return d.categories=new y("categories")},m=function(){return d.categories||g()},v=function(t){function e(t){var n;return _classCallCheck(this,e),n=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this,t)),n.state={loading:!0},n}return _inherits(e,t),_createClass(e,[{key:"componentDidMount",value:function(){this.updateData(),this.getDataStore().registeredData()&&this.setState({loading:!1})}},{key:"componentWillUnmount",value:function(){c(this.fetchRequest,["abort"]),c(this.addRequest,["abort"])}},{key:"componentDidUpdate",value:function(t,e){if(this.updateData(),this.props.terms.length>2&&!this.getDataStore().get("availableTerms"))this.fetchTerms();else if(this.props.terms!==t.terms){var n=this.props.terms.filter(function(e){return-1===t.terms.indexOf(e)});n.length&&!this.isTermAvailable(n[0])&&(this.fetchTerms(),this.saveMainCategory())}var r=l("core/editor").isSavingPost(),o=l("core/editor").isAutosavingPost(),i=l("core/editor").isPreviewingPost();!r||o||i||this.saveMainCategory()}},{key:"saveMainCategory",value:function(){var t={value:s(),post_id:document.getElementById("post_ID").value,nonce:wpmc.nonce};wp.apiRequest({path:"/wpmc/v1/update-main-category",method:"POST",data:t}).then(function(t){return t},function(t){return t})}},{key:"updateData",value:function(){this.getDataStore().registeredData()||(this.getDataStore().set("availableTerms",[]),this.fetchTerms()),this.getDataStore().set("selectedTerms",this.props.terms)}},{key:"getDataStore",value:function(){return m()}},{key:"isTermAvailable",value:function(t){return this.getDataStore().get("availableTerms").some(function(e){return e.id===t})}},{key:"fetchTerms",value:function(){var t=this,e=this.props.taxonomy;e&&(this.setState({selectedTerms:this.props.terms,loading:!0}),this.fetchRequest=a({path:i("/wp/v2/".concat(e.rest_base),p)}),this.fetchRequest.then(function(e){t.fetchRequest=null,t.setState({loading:!1}),t.getDataStore().set("availableTerms",e),t.forceUpdate()},function(e){"abort"!==e.statusText&&(t.fetchRequest=null,t.setState({loading:!1}),t.forceUpdate())}))}}]),e}(React.Component),_=function(t){function e(t){var n;return _classCallCheck(this,e),n=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this,t)),n.onChange=n.onChange.bind(_assertThisInitialized(n)),n}return _inherits(e,t),_createClass(e,[{key:"getTermName",value:function(t){var e=this.getDataStore().get("availableTerms"),n=e.find(function(e){return e.id===t});return n&&n.name||""}},{key:"getSelectOptions",value:function(){var t=this,e=this.getDataStore().get("selectedTerms").sort().map(function(e){return{value:e,label:t.getTermName(e)}});return u(e,"label")}},{key:"onChange",value:function(t){this.setState({options:this.getSelectOptions(),value:h(t)}),$(".edit-post-header__settings").find(".components-button.editor-post-publish-button").attr("aria-disabled",!1)}},{key:"isDisabled",value:function(){return this.state.loading}},{key:"render",value:function(){this.updateData();var t=s();return n(o,{label:f("Primary Category","wp-main-category"),value:t,className:"wpmc-select",onChange:this.onChange,options:this.state.loading?"":this.getSelectOptions(),disabled:this.isDisabled()})}}]),e}(v);t("editor.PostTaxonomyType","wpmc/select",function(t){return function(e){function o(){return _classCallCheck(this,o),_possibleConstructorReturn(this,_getPrototypeOf(o).apply(this,arguments))}return _inherits(o,e),_createClass(o,[{key:"initSelectors",value:function(){var t=this.props,e=t.slug,o=t.terms;if("category"===e)return o.length>1?n(r,{},n(_,this.props)):null}},{key:"render",value:function(){return n(r,{},n(t,this.props),this.initSelectors())}}]),o}(v)},20)}}();$(window).load(function(){WPMainCategoryGutenberg()});